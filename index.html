<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:,">
  <title>solc-metadata</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, avenir next, avenir, segoe ui, helvetica neue, helvetica, Cantarell, Ubuntu, roboto, noto, arial, sans-serif;
      background: hsl(216deg 70% 95%);
      color: hsl(216deg 70% 5%);
    }

    header {
      display: flex;
      justify-content: center;
    }

    main {
      inline-size: min(720px, 100% - 16px);
      margin-inline: auto;
    }

    a {
      display: block;
      margin-block: 24px;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-weight: 700;
    }

    input {
      font-size: 1rem;
      margin-block-end: 8px;
      padding: 8px;
      border: 1px solid hsl(216deg 70% 50%);
      border-radius: 4px;
      transition: filter 600ms;
    }

    button {
      inline-size: fit-content;
      font-size: 1rem;
      padding: 4px 6px;
      background: hsl(216deg 50% 95%);
      border: 1px solid hsl(216deg 70% 50%);
      border-radius: 4px;
      cursor: pointer;
      transition: filter 600ms;
    }

    :is(input, button):is(:hover, :focus-within) {
      filter: drop-shadow(0 0 2px hsl(216deg 70% 50%));
      transition: filter 200ms;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
  </style>
</head>

<body>
  <header>
    <h1>solc-metadata</h1>
  </header>

  <main>
    <a href="https://github.com/ardislu/solc-metadata">GitHub</a>

    <form>
      <label for="address">Smart contract address</label>
      <input name="address" id="address" value="0x63c1735a6b7419ae4c7b87c486ac7c393d983980" required data-1p-ignore data-lpignore>

      <label for="rpc">JSON-RPC node</label>
      <input type="url" name="rpc" id="rpc" required value="https://eth.ardis.lu/v1/sepolia">

      <label for="ipfs">IPFS gateway</label>
      <input type="url" name="ipfs" id="ipfs" required value="https://cf-ipfs.com">

      <button>Get metadata</button>

      <label for="result" class="sr-only">Full JSON metadata</label>
      <output name="result" id="result"></output>
    </form>
  </main>

  <script type="module">
    import { fetchBytecode, extractCBOR, decodeCBOR, calculateCID, fetchJSONMetadata } from '/index.js';

    document.querySelector('form').addEventListener('submit', async e => {
      e.preventDefault();

      const data = new FormData(e.target);
      const address = data.get('address');
      const rpc = new URL(data.get('rpc'));
      const ipfs = new URL(data.get('ipfs'));
      const result = e.target.elements['result'];

      const bytecode = await fetchBytecode(address, rpc);
      const cbor = extractCBOR(bytecode);
      const metadata = decodeCBOR(cbor);
      const { cidV0, cidV1 } = calculateCID(metadata);
      const json = await fetchJSONMetadata(cidV1, ipfs);

      result.textContent = JSON.stringify(json);
    })
  </script>
</body>

</html>