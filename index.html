<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:,">
  <title>solc-metadata</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, avenir next, avenir, segoe ui, helvetica neue, helvetica, Cantarell, Ubuntu, roboto, noto, arial, sans-serif;
    }

    header {
      display: flex;
      justify-content: center;
    }

    main {
      inline-size: min(720px, 100% - 16px);
      margin-inline: auto;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    form * {
      inline-size: fit-content;
    }
  </style>
</head>

<body>
  <header>
    <h1>solc-metadata</h1>
  </header>

  <main>
    <form>
      <label for="address">Smart contract address</label>
      <input name="address" id="address" value="0x63c1735a6b7419ae4c7b87c486ac7c393d983980" required data-1p-ignore data-lpignore>

      <label for="rpc">JSON-RPC node</label>
      <input type="url" name="rpc" id="rpc" required value="https://eth.ardis.lu/v1/sepolia">

      <label for="ipfs">IPFS gateway</label>
      <input type="url" name="ipfs" id="ipfs" required value="https://cf-ipfs.com">

      <button>Get metadata</button>

      <label for="result">Full JSON metadata</label>
      <output name="result" id="result"></output>
    </form>
  </main>

  <script type="module">
    import { fetchBytecode, extractCBOR, decodeCBOR, calculateCID, fetchJSONMetadata } from '/index.js';

    document.querySelector('form').addEventListener('submit', async e => {
      e.preventDefault();

      const data = new FormData(e.target);
      const address = data.get('address');
      const rpc = new URL(data.get('rpc'));
      const ipfs = new URL(data.get('ipfs'));
      const result = e.target.elements['result'];

      const bytecode = await fetchBytecode(address, rpc);
      const cbor = extractCBOR(bytecode);
      const metadata = decodeCBOR(cbor);
      const { cidV0, cidV1 } = calculateCID(metadata);
      const json = await fetchJSONMetadata(cidV1, ipfs);

      result.textContent = JSON.stringify(json);
    })
  </script>
</body>

</html>